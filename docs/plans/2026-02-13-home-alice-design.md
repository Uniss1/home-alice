# Home Alice — Управление домашним ПК через Яндекс Алису

**Дата:** 2026-02-13

## Цель

Голосовое управление домашним Windows-ПК через Яндекс Алису: поиск и запуск видео на VK Video, выключение/перезагрузка компьютера. С возможностью расширения команд в будущем.

## Архитектура

```
┌─────────────┐   webhook    ┌──────────────┐   WebSocket   ┌──────────────┐
│   Алиса      │ ──────────→ │  VPS-сервер   │ ────────────→ │  PC-агент    │
│ (Диалоги)    │ ←────────── │  (FastAPI)    │ ←──────────── │  (Windows)   │
└─────────────┘              └──────┬───────┘               └──────────────┘
                                    │
                              ┌─────┴─────┐
                              │           │
                         ┌────▼───┐  ┌───▼────┐
                         │YandexGPT│  │ VK API │
                         └────────┘  └────────┘
```

### Компоненты

1. **VPS-сервер** (FastAPI + WebSocket) — принимает webhook от Яндекс.Диалогов, парсит команды через YandexGPT, ищет видео через VK API, отправляет готовые действия на ПК.
2. **PC-агент** (Python, Windows) — держит WebSocket-соединение с VPS, выполняет команды локально (открыть URL, выключить ПК).
3. **YandexGPT** — парсит свободный текст в структурированные команды (JSON).
4. **VK API** — поиск видео (`video.search`), сортировка по популярности.

## Поток команды

1. Пользователь: "Алиса, [навык], покажи смешных котиков"
2. Яндекс.Диалоги → POST webhook на VPS с текстом
3. VPS отправляет текст в YandexGPT с системным промптом-парсером
4. YandexGPT возвращает: `{"action": "open_vk_video", "query": "смешные котики"}`
5. VPS вызывает VK API `video.search("смешные котики")` → выбирает самое просматриваемое видео
6. VPS отправляет `{"action": "open_url", "url": "https://vk.com/video..."}` на ПК через WebSocket
7. PC-агент открывает URL в браузере по умолчанию
8. VPS отвечает Алисе: "Включаю видео со смешными котиками"

## VPS-сервер

### Технологии
- Python, FastAPI, websockets, httpx

### Эндпоинты
- `POST /alice/webhook` — webhook от Яндекс.Диалогов
- `WebSocket /ws/agent` — подключение PC-агента (аутентификация через API-ключ)

### Парсинг команд (YandexGPT)

Системный промпт:
```
Ты — парсер голосовых команд для управления ПК.
Доступные действия:
- shutdown: выключить компьютер
- reboot: перезагрузить компьютер
- open_vk_video: найти и открыть видео на VK (параметры: query, channel?)
- open_url: открыть произвольный URL в браузере

Верни JSON: {"action": "...", "params": {...}}
Если команда не распознана — {"action": "unknown"}
```

### Поиск VK Video
- Используем `video.search` API метод
- Сортировка по релевантности + выбор самого просматриваемого из результатов
- Поддержка поиска внутри конкретного канала/группы через `owner_id`
- Избранные каналы хранятся в конфигурации

### Конфигурация (`config.yaml`)
```yaml
api_key: "секретный-ключ-для-агента"
vk_token: "токен-VK-API"
yandex_gpt_api_key: "ключ-YandexGPT"
yandex_gpt_folder_id: "id-каталога-в-облаке"
favorite_channels:
  "канал1": -123456789
  "канал2": -987654321
```

## PC-агент (Windows)

### Технологии
- Python, websockets (клиент), subprocess, webbrowser

### Поведение
- При запуске подключается к VPS по WebSocket
- Держит соединение, ожидает команды
- При обрыве — переподключение каждые 5 секунд
- Автозапуск через Task Scheduler

### Команды

| Действие | Реализация |
|----------|------------|
| `shutdown` | `subprocess.run(["shutdown", "/s", "/t", "0"])` |
| `reboot` | `subprocess.run(["shutdown", "/r", "/t", "0"])` |
| `open_url` | `webbrowser.open(url)` с проверкой белого списка доменов |

### Безопасность
- Белый список разрешённых действий
- Белый список доменов для open_url (настраивается в config)
- API-ключ для подключения к VPS

### Конфигурация (`config.yaml`)
```yaml
server_url: "wss://your-vps.com/ws/agent"
api_key: "секретный-ключ"
allowed_domains:
  - "vk.com"
  - "youtube.com"
```

## Обработка ошибок

| Ситуация | Ответ Алисы |
|----------|-------------|
| ПК не подключён | "Компьютер сейчас недоступен" |
| Команда не распознана | "Не поняла команду. Попробуй сказать иначе" |
| VK API не нашёл видео | "Не нашла видео по запросу [X]" |
| Таймаут ответа от ПК (>5 сек) | "Команда отправлена, но ПК не ответил" |
| WebSocket разорвался | Агент автоматически переподключается |

## Структура проекта

```
home_alice/
├── server/                  # VPS-сервер
│   ├── main.py              # FastAPI + WebSocket сервер
│   ├── alice_handler.py     # Обработка webhook от Диалогов
│   ├── command_parser.py    # YandexGPT парсинг команд
│   ├── vk_video.py          # Поиск видео через VK API
│   ├── config.yaml          # Конфигурация
│   └── requirements.txt
├── agent/                   # PC-агент (Windows)
│   ├── main.py              # WebSocket клиент + диспетчер команд
│   ├── commands/
│   │   ├── system.py        # shutdown, reboot
│   │   └── browser.py       # open_url с белым списком
│   ├── config.yaml          # Конфигурация агента
│   └── requirements.txt
└── docs/
    └── plans/
```

## Будущее развитие

Текущая архитектура — MVP для одного пользователя. Для превращения в сервис потребуется:
- Авторизация и личные кабинеты (OAuth + БД)
- Windows-инсталлер с GUI (PyInstaller / Electron)
- Аккаунт-линкинг в Яндекс.Диалогах
- Дополнительные команды (громкость, запуск приложений, управление плеером)

Текущие решения (разделение server/agent, JSON-протокол, config-based подход) не препятствуют этому развитию.
